---
title: "Exercise 9"
author: "Cameron Bale"
format: docx
---

Multiple regression is often referred to as "key drivers analysis" in business applications. Kroger has requested a key drivers analysis for `Sales` of `CAMPBELL'S` brand products in the `WEST CENSUS TA` Retailer Trade Area.

1. Build at least two different regression models for `Sales` using any combination of the variables `Any_Disp_Spend` (spend on in-store displays), `Any_Feat_Spend` (spend on coupons and other printed promotions, collectively called "features"), and `Any_Price_Decr_Spend` (spend on price decreases).
2. Compare each of the models' R-squared. Which one explains the most variation in `Sales`?
3. What are some omitted variables that could affect the estimates of the coefficients in your model? No need to build an exhaustive list, just come up with one plausible example.
4. Using the best fitting model from part 2, predict counterfactual `Sales` for Campbellâ€™s. Assume that Kroger can spend up to $10,000 for this trading area. Produce predictions for three counterfactual scenarios and use them to detail a proposal for how Kroger should promote Campbell's products for the `WEST CENSUS TA`.
5. Render the Quarto document into Word and upload to Canvas.

**Five points total, one point for each numbered task above.**

## Model Building

Let's load all the packages we'll need.

```{r}
# Load packages.
library(tidyverse)
library(tidymodels)
```

Import the data and filter for the desired trade area and brand.

```{r}
# Import and filter data.
soup_data <- read_csv("soup_data.csv", show_col_types = FALSE) |> 
  filter(Retailer_Trade_Areas == "WEST CENSUS TA", Brand_High == "CAMPBELL'S")
```

Fit a model with all three explanatory variables and view parameter estimates.

```{r}
# Full model (all three explanatory variables).
fit_01 <- linear_reg() |> 
  set_engine(engine = "lm") |> 
  fit(
    Sales ~ Any_Disp_Spend + Any_Feat_Spend + Any_Price_Decr_Spend, 
    data = soup_data
  )

# Print parameter estimates.
tidy(fit_01, conf.int = TRUE)
```

All of the parameter estimates are significant, but the effect of each of the explanatory variables on the outcome are very small, especially compared to the intercept.

```{r}
# Visualize parameter estimates.
tidy(fit_01, conf.int = TRUE) |> 
  ggplot(aes(x = term)) + 
  geom_point(aes(y = estimate)) + 
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = .1) +
  geom_hline(yintercept = 0, color = "red")
```

The scale is so different between the intercept and the slope parameters that we can't even see the difference between the slope parameters. Since the slope parameters are really what we're interested in here, let's just plot them.

```{r}
# Visualize slope parameter estimates.
tidy(fit_01, conf.int = TRUE) |> 
  filter(term != "(Intercept)") |> 
  ggplot(aes(x = term)) + 
  geom_point(aes(y = estimate)) + 
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = .1) +
  geom_hline(yintercept = 0, color = "red")
```

Display spend clearly matters the most. In fact, it's the only one of the parameters with a confidence interval that suggests it might have an effect on `Sales` greater than 1 (i.e., would yield a positive return on investment).

Fit a second model with only feature and price decrease spend.

```{r}
# Model without display spend.
fit_02 <- linear_reg() |> 
  set_engine(engine = "lm") |> 
  fit(
    Sales ~ Any_Feat_Spend + Any_Price_Decr_Spend, 
    data = soup_data
  )

# Visualize slope parameter estimates.
tidy(fit_02, conf.int = TRUE) |> 
  filter(term != "(Intercept)") |> 
  ggplot(aes(x = term)) + 
  geom_point(aes(y = estimate)) + 
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = .1) +
  geom_hline(yintercept = 0, color = "red")
```

If we leave out display spend, we can see that feature spend is suddenly much more important, even greater than 1. Price decrease spend stays about the same.

It is possible that products that are featured are typically also displayed, meaning these variables are correlated with each other, and are both correlated with sales. By excluding display, the model could be overestimating the effect of feature.

My understanding of sales says that all three of the explanatory variables should be included in the model. We can also compare the overall model fit to see which one is indeed the "best-fitting model."

```{r}
# Model comparison.
tibble(
  model = c(
    "Full model", 
    "Model without display spend"
  )
) |> 
  bind_cols(
    bind_rows(
      glance(fit_01), 
      glance(fit_02)
    )
  ) |> 
  arrange(desc(r.squared))
```

The "full model" that includes all three of the explanatory variables fits best according to the R-squared overall fit statistic.

## Exploring Omitted Variable Bias

One omitted variable that would likely affect our estimates could be the promotion and feature decisions of other products. For example, if a non-campbell's brand product was on display, it would mean campbell's would not be on display, thus establishing a correlation between the two display decisions. And, since displays are meant to attract attention and encourage impulse purchases, the display of another product might cause consumers to purchase that product instead, thereby reducing Campbell's sales. Overall, it would be important to capture competitor information in our model.

## Counterfactual Predictions

Let's use the full model to predict `Sales`. Note that we are assuming we have $10,000 to spend across all three of the explanatory variables.

```{r}
# Create new data representing various counterfactual scenarios for spending our budget.
scenarios <- tibble(
  Any_Disp_Spend = c(10000, 0, 0, 10000/3),
  Any_Feat_Spend = c(0, 10000, 0, 10000/3),
  Any_Price_Decr_Spend = c(0, 0, 10000, 10000/3)
)

# Predict sales using fit_01.
predict(fit_01, new_data = scenarios) |> 
  bind_cols(
    predict(fit_01, new_data = scenarios, type = "pred_int"),
    scenarios
  ) |> 
  arrange(desc(.pred))
```

Based on our model, the best thing Campbell's can do in this trade area is put the entire promotional spend budget in displays. We inferred this from it being the most important of the explanatory variables, but now we can directly see that spending $10,000 on display should produce sales of about $263,026 dollars. Or, even better, the prediction says such a display spend should produce sales anywhere from $140,634 to $385,418, accounting for the uncertainty in our parameter estimates.